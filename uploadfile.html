<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>อัปโหลดไฟล์เพื่อฝากไว้ปริ้น</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f7f8fa;
            margin: 0;
            padding: 0;
            color: #333;
        }
        .container {
            width: 85%;
            margin: 50px auto;
            text-align: center;
        }
        h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 20px;
        }
        h2 {
            color: #444;
            font-size: 1.5em;
            margin-bottom: 20px;
        }
        .upload-section {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }
        label {
            padding: 12px 20px;
            background-color: #4CAF50;
            color: white;
            border-radius: 5px;
            font-size: 1.2em;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        label:hover {
            background-color: #45a049;
        }
        input[type="file"] {
            display: none;
        }
        .message {
            background-color: #dff0d8;
            color: #3c763d;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 1.1em;
            display: none;
        }
        .file-list {
            list-style-type: none;
            padding: 0;
            margin-top: 30px;
        }
        .file-list li {
            background-color: #fff;
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .file-list li:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }
        .file-list li a {
            text-decoration: none;
            color: #007bff;
            font-weight: bold;
        }
        .file-list li button {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .file-list li button:hover {
            background-color: #d32f2f;
        }
        .loading-spinner {
            width: 30px;
            height: 30px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .button {
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            background-color: #ffffff;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .countdown {
            font-size: 36px;
            color: #007bff;
            margin-bottom: 20px;
        }
        .btn-refresh {
            background-color: #007bff;
            color: white;
            padding: 15px 25px;
            font-size: 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .btn-refresh:hover {
            background-color: #0056b3;
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>อัปโหลดไฟล์เพื่อฝากไว้ปริ้น</h1>
        <div class="upload-section">
            <label for="file-upload">Upload File</label>
            <input type="file" id="file-upload" onchange="uploadFile()" />
        </div>
        <div id="upload-message" class="message"></div>
        <h2>ไฟล์ที่อัปโหลดไว้</h2>
        <ul class="file-list" id="file-list"></ul>
    </div>

    <div class="progress-container">
        <progress id="progress-bar" value="0" max="100"></progress>
        <span id="progress-percentage">0%</span>
    </div>
    
    <style>
        .progress-container {
            margin: 20px 0;
            text-align: center;
            display: none; /* ซ่อนเริ่มต้น */
        }
        progress {
            width: 100%;
            height: 20px;
            border: none;
            background-color: #f3f3f3;
            border-radius: 10px;
            overflow: hidden;
        }
        progress::-webkit-progress-bar {
            background-color: #f3f3f3;
        }
        progress::-webkit-progress-value {
            background-color: #4CAF50;
            transition: width 0.2s ease-in-out;
        }
        progress::-moz-progress-bar {
            background-color: #4CAF50;
            transition: width 0.2s ease-in-out;
        }
        #progress-percentage {
            margin-top: 10px;
            font-size: 1em;
            font-weight: bold;
            color: #333;
        }
    </style>

<div class="container">
    <div class="countdown" id="countdown">60</div>
    <button class="btn-refresh" onclick="refreshPage()">Refresh Now</button>
</div>

<script>
    let countdownTime = 60;

    function updateCountdown() {
        document.getElementById('countdown').innerText = countdownTime;
        if (countdownTime <= 0) {
            location.reload(); // Refresh the page when countdown reaches 0
        } else {
            countdownTime--;
        }
    }

    function refreshPage() {
        location.reload(); // Refresh the page immediately when the button is clicked
    }

    // Update countdown every second
    setInterval(updateCountdown, 1000);
</script>


    <div id="upload-progress-container" style="display: none;">
        <div id="upload-progress" style="
            width: 0;
            height: 20px;
            background-color: #3498db;
            border-radius: 10px;
            transition: width 0.3s ease;"></div>
    </div>

    <div id="delete-progress-container" style="display: none;">
        <div id="delete-progress" style="
            width: 0;
            height: 20px;
            background-color: #e74c3c;
            border-radius: 10px;
            transition: width 0.3s ease;"></div>
    </div>
    
    

    <script>
        const token = process.env.TOKEN;
        const repoOwner = "flownorthz";
        const repoName = "Upload_File";
        const branch = "main";
        const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/`;

        // Fetch and display files
        async function fetchFiles() {
            try {
                const response = await fetch(apiUrl, {
                    headers: {
                        Authorization: `token ${token}`
                    }
                });
                const data = await response.json();
                const fileList = document.getElementById('file-list');
                fileList.innerHTML = '';  // Clear file list

                data.forEach(file => {
                    if (file.type === 'file') {
                        const listItem = document.createElement('li');
                        listItem.innerHTML = `
                            <a href="${file.download_url}" target="_blank">${file.name}</a>
                            <button onclick="deleteFile('${file.path}')">Delete</button>
                        `;
                        fileList.appendChild(listItem);
                    }
                });
            } catch (error) {
                console.error('Error fetching files:', error);
            }
        }

        // Upload file to GitHub
        async function uploadFile() {
            const fileInput = document.getElementById('file-upload');
            const file = fileInput.files[0];
            const messageBox = document.getElementById('upload-message');

            if (!file) {
                alert("Please select a file to upload");
                return;
            }

            messageBox.style.display = 'none';  // Hide previous messages

            const reader = new FileReader();
            reader.onload = async function() {
                const fileContent = reader.result.split(',')[1];  // Get the file content

                // Display loading spinner
                messageBox.innerHTML = 'Uploading file... <div class="loading-spinner"></div>';
                messageBox.style.display = 'block';

                const response = await fetch(apiUrl + file.name, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Upload ${file.name}`,
                        content: fileContent,
                        branch: branch
                    })
                });

                const data = await response.json();
                if (data.content) {
                    messageBox.innerHTML = `ไฟล์อัปโหลดสำเร็จ : ${file.name}`;
                    setTimeout(() => messageBox.style.display = 'none', 5000);  // Hide after 5 seconds
                    fetchFiles();  // Refresh file list
                } else {
                    messageBox.innerHTML = `ไฟล์อัปโหลดไม่สำเร็จ : ${file.name}`;
                    setTimeout(() => messageBox.style.display = 'none', 5000);  // Hide after 5 seconds
                }
            };
            reader.readAsDataURL(file);
        }

        

        // Delete file from GitHub
        async function deleteFile(filePath) {
            const confirmation = confirm("Are you sure you want to delete this file?");
            if (confirmation) {
                
            try {
            // First, fetch the file details to get the 'sha'
            const fileResponse = await fetch(apiUrl + encodeURIComponent(filePath), {
                headers: {
                    'Authorization': `token ${token}`
                }
            });

            const fileData = await fileResponse.json();

            if (!fileData.sha) {
                alert("Error fetching file details");
                return;
            }

            // Now delete the file using the 'sha'
            const deleteResponse = await fetch(apiUrl + encodeURIComponent(filePath), {
                method: 'DELETE',
                headers: {
                    'Authorization': `token ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: `Delete ${filePath}`,
                    sha: fileData.sha,  // The sha is required to delete the file
                    branch: branch
                })
            });

            const deleteData = await deleteResponse.json();
            if (deleteData.message === "Deleted") {
                alert("File deleted successfully!");
                fetchFiles();  // Refresh file list
            } else {
                alert("Error deleting file: " + deleteData.message);
            }
        } catch (error) {
            console.error('Error during file deletion:', error);
            alert("An error occurred while deleting the file.");
        }
    }
}

async function deleteFile(filePath) {
    const confirmation = confirm("Are you sure you want to delete this file?");
    if (!confirmation) return;

    const progressContainer = document.getElementById('delete-progress-container');
    const progressBar = document.getElementById('delete-progress');
    progressContainer.style.display = 'block';  // Show progress bar
    progressBar.style.width = '0';  // Reset progress bar

    try {
        const fileResponse = await fetch(apiUrl + encodeURIComponent(filePath), {
            headers: { 'Authorization': `token ${token}` }
        });
        const fileData = await fileResponse.json();

        if (!fileData.sha) throw new Error("Error fetching file details");

        const deleteRequest = fetch(apiUrl + encodeURIComponent(filePath), {
            method: 'DELETE',
            headers: {
                'Authorization': `token ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: `Delete ${filePath}`,
                sha: fileData.sha,
                branch: branch
            })
        });

        const response = await monitorProgress(deleteRequest, progress => {
            progressBar.style.width = `${progress}%`;
        });

        const deleteData = await response.json();
        if (deleteData.message === "Deleted") {
            alert("File deleted successfully!");
            fetchFiles();  // Refresh file list
        } else {
            throw new Error("Error deleting file: " + deleteData.message);
        }
    } catch (error) {
        console.error('Error during file deletion:', error);
        alert("An error occurred while deleting the file.");
    } finally {
        progressContainer.style.display = 'none';  // Hide progress bar
    }
}


async function uploadFile() {
    const fileInput = document.getElementById('file-upload');
    const file = fileInput.files[0];
    const messageBox = document.getElementById('upload-message');
    const progressContainer = document.getElementById('upload-progress-container');
    const progressBar = document.getElementById('upload-progress');

    if (!file) {
        alert("Please select a file to upload");
        return;
    }

    messageBox.style.display = 'none';  // Hide previous messages
    progressContainer.style.display = 'block';  // Show progress bar
    progressBar.style.width = '0';  // Reset progress bar width

    const reader = new FileReader();
    reader.onload = async function() {
        const fileContent = reader.result.split(',')[1];  // Get the file content

        const uploadRequest = fetch(apiUrl + file.name, {
            method: 'PUT',
            headers: {
                'Authorization': `token ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: `Upload ${file.name}`,
                content: fileContent,
                branch: branch
            })
        });

        const response = await monitorProgress(uploadRequest, progress => {
            progressBar.style.width = `${progress}%`;
        });

        const data = await response.json();
        if (data.content) {
            messageBox.innerHTML = `ไฟล์อัปโหลดสำเร็จ : ${file.name}`;
            fetchFiles();  // Refresh file list
        } else {
            messageBox.innerHTML = `ไฟล์อัปโหลดไม่สำเร็จ : ${file.name}`;
        }

        progressContainer.style.display = 'none';  // Hide progress bar
    };
    reader.readAsDataURL(file);
}

async function uploadFile() {
    const fileInput = document.getElementById('file-upload');
    const file = fileInput.files[0];
    const progressBar = document.getElementById('progress-bar');
    const progressPercentage = document.getElementById('progress-percentage');
    const progressContainer = document.querySelector('.progress-container');

    if (!file) {
        alert("Please select a file to upload");
        return;
    }

    progressContainer.style.display = 'block'; // แสดง Progress Bar
    progressBar.value = 0;
    progressPercentage.innerText = '0%';

    const reader = new FileReader();
    reader.onload = async function () {
        const fileContent = reader.result.split(',')[1]; // Get base64 content
        const totalLength = file.size;

        const xhr = new XMLHttpRequest();
        xhr.open('PUT', apiUrl + file.name, true);
        xhr.setRequestHeader('Authorization', `token ${token}`);
        xhr.setRequestHeader('Content-Type', 'application/json');

        xhr.upload.onprogress = function (event) {
            if (event.lengthComputable) {
                const progress = Math.round((event.loaded / totalLength) * 100);
                progressBar.value = progress;
                progressPercentage.innerText = `${progress}%`;
            }
        };

        xhr.onload = function () {
            if (xhr.status === 201) {
                alert('กำลังอัปโหลด');
                progressBar.value = 100;
                progressPercentage.innerText = '100%';
                fetchFiles(); // Refresh file list
            } else {
                alert('Error uploading file: ' + xhr.responseText);
            }
            progressContainer.style.display = 'none'; // ซ่อน Progress Bar หลังเสร็จ
        };

        xhr.onerror = function () {
            alert('An error occurred during upload');
            progressContainer.style.display = 'none';
        };

        xhr.send(JSON.stringify({
            message: `Upload ${file.name}`,
            content: fileContent,
            branch: branch
        }));
    };
    reader.readAsDataURL(file);
}

async function deleteFile(filePath) {
    const progressBar = document.getElementById('progress-bar');
    const progressPercentage = document.getElementById('progress-percentage');
    const progressContainer = document.querySelector('.progress-container');
    const confirmation = confirm("Are you sure you want to delete this file?");
    
    if (!confirmation) return;

    progressContainer.style.display = 'block';
    progressBar.value = 0;
    progressPercentage.innerText = '0%';

    try {
        // Fetch file SHA
        const fileResponse = await fetch(apiUrl + encodeURIComponent(filePath), {
            headers: {
                'Authorization': `token ${token}`
            }
        });
        const fileData = await fileResponse.json();
        if (!fileData.sha) {
            alert("Error fetching file details");
            progressContainer.style.display = 'none';
            return;
        }

        // Delete file
        const deleteRequest = new XMLHttpRequest();
        deleteRequest.open('DELETE', apiUrl + encodeURIComponent(filePath), true);
        deleteRequest.setRequestHeader('Authorization', `token ${token}`);
        deleteRequest.setRequestHeader('Content-Type', 'application/json');

        deleteRequest.onload = function () {
            if (deleteRequest.status === 200) {
                alert("กำลังลบไฟล์");
                progressBar.value = 100;
                progressPercentage.innerText = '100%';
                fetchFiles(); // Refresh file list
            } else {
                alert("Error deleting file: " + deleteRequest.responseText);
            }
            progressContainer.style.display = 'none';
        };

        deleteRequest.onerror = function () {
            alert('An error occurred during deletion');
            progressContainer.style.display = 'none';
        };

        deleteRequest.send(JSON.stringify({
            message: `Delete ${filePath}`,
            sha: fileData.sha,
            branch: branch
        }));
    } catch (error) {
        console.error('Error:', error);
        alert("An error occurred while deleting the file.");
        progressContainer.style.display = 'none';
    }
}


// Helper function to simulate progress
async function monitorProgress(fetchPromise, onProgress) {
    const delay = 50;  // Simulate progress delay in ms
    let progress = 0;
    while (progress < 100) {
        progress += Math.random() * 20;  // Simulate progress increment
        onProgress(Math.min(progress, 100));
        await new Promise(resolve => setTimeout(resolve, delay));
    }
    return fetchPromise;
}


        // Fetch files when the page loads
        window.onload = fetchFiles;
    </script>
</body>
</html>
